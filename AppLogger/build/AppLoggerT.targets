<!--
  AppLoggerT MSBuild Targets
  Automatically detects and references ETABS API DLL
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- ========================================
         ETABS Installation Detection
         Focused on ETABS 22 for .NET 10
         ======================================== -->
	<PropertyGroup>
		<!-- Check ETABS 22 (64-bit) -->
		<EtabsInstallDir Condition="'$(EtabsInstallDir)' == '' AND Exists('C:\Program Files\Computers and Structures\ETABS 22\ETABSv1.dll')">C:\Program Files\Computers and Structures\ETABS 22</EtabsInstallDir>

		<!-- Check ETABS 22 (32-bit) -->
		<EtabsInstallDir Condition="'$(EtabsInstallDir)' == '' AND Exists('C:\Program Files (x86)\Computers and Structures\ETABS 22\ETABSv1.dll')">C:\Program Files (x86)\Computers and Structures\ETABS 22</EtabsInstallDir>

		<!-- Allow user override via MSBuild property or environment variable -->
		<EtabsInstallDir Condition="'$(EtabsInstallDir)' == '' AND '$(ETABS_INSTALL_DIR)' != ''">$(ETABS_INSTALL_DIR)</EtabsInstallDir>
	</PropertyGroup>

	<!-- ========================================
         Add ETABS Reference (if found)
         ======================================== -->
	<ItemGroup Condition="'$(EtabsInstallDir)' != ''">
		<Reference Include="ETABSv1">
			<HintPath>$(EtabsInstallDir)\ETABSv1.dll</HintPath>
			<!-- 
			CRITICAL FOR COM INTEROP:
			- Private=true: Copy the DLL to output directory
			- EmbedInteropTypes=false: Don't embed types (causes runtime issues with COM)
			-->
			<Private>true</Private>
			<EmbedInteropTypes>false</EmbedInteropTypes>
		</Reference>
	</ItemGroup>

	<!-- ========================================
         Build Diagnostics
         ======================================== -->
	<Target Name="AppLoggerT_DiagnosticInfo"
			BeforeTargets="Build"
			Condition="'$(EtabsInstallDir)' != ''">
		<Message Text="════════════════════════════════════════" Importance="high" />
		<Message Text="[AppLoggerT] ETABS detected at: $(EtabsInstallDir)" Importance="high" />
		<Message Text="[AppLoggerT] ETABSv1.dll will be copied to output" Importance="high" />
		<Message Text="════════════════════════════════════════" Importance="high" />
	</Target>

	<Target Name="AppLoggerT_WarnIfEtabsMissing"
			BeforeTargets="Build"
			Condition="'$(EtabsInstallDir)' == ''">
		<Warning Text="[AppLoggerT] ETABS installation not detected. ETABSv1.dll was not referenced automatically. ETABS-specific features will not be available. To manually specify ETABS location, set the ETABS_INSTALL_DIR environment variable or MSBuild property." />
	</Target>

	<!-- ========================================
         EXPLICIT Copy Target (Backup mechanism)
         This ensures DLL is copied even if Private=true fails
         ======================================== -->
	<Target Name="CopyEtabsDllToOutput"
	        AfterTargets="Build"
	        Condition="'$(EtabsInstallDir)' != '' AND '$(TargetFramework)' != ''">

		<PropertyGroup>
			<EtabsDllSource>$(EtabsInstallDir)\ETABSv1.dll</EtabsDllSource>
			<EtabsDllDestination>$(OutputPath)ETABSv1.dll</EtabsDllDestination>
		</PropertyGroup>

		<Message Text="[AppLoggerT] ─────────────────────────────" Importance="high" />
		<Message Text="[AppLoggerT] Copying ETABS DLL..." Importance="high" />
		<Message Text="[AppLoggerT]   From: $(EtabsDllSource)" Importance="high" />
		<Message Text="[AppLoggerT]   To:   $(EtabsDllDestination)" Importance="high" />

		<!-- Perform the copy -->
		<Copy SourceFiles="$(EtabsDllSource)"
		      DestinationFiles="$(EtabsDllDestination)"
		      SkipUnchangedFiles="false"
		      OverwriteReadOnlyFiles="true"
		      Condition="Exists('$(EtabsDllSource)')" />

		<!-- Verify the copy -->
		<Message Text="[AppLoggerT] ✓ Copy completed successfully!" Importance="high" Condition="Exists('$(EtabsDllDestination)')" />
		<Warning Text="[AppLoggerT] ✗ Copy failed - DLL not found at destination!" Condition="!Exists('$(EtabsDllDestination)')" />
		<Message Text="[AppLoggerT] ─────────────────────────────" Importance="high" />
	</Target>

</Project>